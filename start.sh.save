#!bin/bash

cd "$(dirname "$0")

# cores

PINK = '\033[38;2;207;24;146m'
WHITE ='\033[38;2;255;255;255m'

clear

echo -e "${THEME_COLOR}====================================================================${NC}"
echo -e "${THEME_COLOR}                Iniciando Local File Transferer                     ${NC}"
echo -e "${THEME_COLOR}====================================================================${NC}"

# 1. Verifica Python
if ! command -v python3 &> /dev/null; then
    print_msg "ERRO" "Python3 nao encontrado. Instale via 'sudo pacman -S python'."
    read -p "Pressione Enter para sair..."
    exit 1
fi

# 2. VENV Setup
if [ ! -d ".venv" ]; then
    print_msg "INFO" "Criando ambiente virtual (.venv)..."
    python3 -m venv .venv
    print_msg "OK" "Ambiente Criado."
else
    print_msg "INFO" "Ambiente Virtual Encontrado."
fi

# 3. Ativa Venv
source .venv/bin/activate

# 4. Requirements
print_msg "INFO" "Verificando dependencias..."
pip install -r requirements.txt > /dev/null 2>&1
if [ $? -eq 0 ]; then
    print_msg "OK" "Dependencias instaladas."
else
    print_msg "ERRO" "Falha ao instalar dependencias."
fi

# 5. Navegação
echo ""
echo -e "${THEME_COLOR}[START] ${TEXT_COLOR}Servidor iniciando. Aguarde.${NC}"
echo ""

cd localFileTransferer || { echo "Pasta não encontrada"; exit 1; }

if [ ! -d "static" ]; then
    mkdir static
fi

# 6. Migrations
print_msg "INFO" "Sincronizando banco de dados..."
python manage.py migrate > /dev/null 2>&1
print_msg "OK" "Banco de dados pronto."

# 7. Superuser
if [ ! -f ".configurado" ]; then
    echo ""
    echo -e "${THEME_COLOR}[PRIMEIRA EXECUCAO]${NC} ${TEXT_COLOR}Crie seu usuario administrador:${NC}"
    python manage.py createsuperuser
    echo "Setup Feito" > .configurado
    echo ""
    print_msg "OK" "Usuario criado."
fi

# 8. BANNER FINAL (Aqui as cores brilham)
clear
echo -e "${THEME_COLOR}=======================================================${NC}"
echo -e "${TEXT_COLOR}                    SERVIDOR ONLINE                    ${NC}"
echo -e "${THEME_COLOR}=======================================================${NC}"
echo ""
echo -e "${THEME_COLOR}  [PC]           ${TEXT_COLOR}Acesse: http://127.0.0.1:8000${NC}"
echo ""

# Pega o IP real
IP_REDE=$(python3 -c "import socket; s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM); s.connect(('8.8.8.8', 80)); print('http://' + s.getsockname()[0] + ':8000'); s.close()" 2>/dev/null)

echo -e "${THEME_COLOR}  [REDE LOCAL]   ${TEXT_COLOR}Acesse: $IP_REDE${NC}"
echo ""
echo -e "${THEME_COLOR}=======================================================${NC}"
echo -e "${TEXT_COLOR}  (Para desligar, pressione CTRL + C)${NC}"

# Roda o servidor
python manage.py runserver 0.0.0.0:8000 --noreload > /dev/null 2>&1

echo ""
echo -e "${THEME_COLOR}[PARADO]${TEXT_COLOR} O servidor foi encerrado.${NC}"
